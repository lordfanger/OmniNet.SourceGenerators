name: Build, Version & Publish NuGet

on:
  workflow_dispatch:

jobs:
  build-pack-publish:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Get current version from csproj
        id: get_version
        shell: pwsh
        run: |
          [xml]$proj = Get-Content "src/OmniNet.SourceGenerators.Core/OmniNet.SourceGenerators.Core.csproj"
          $version = $proj.Project.PropertyGroup.Version
          if (-not $version) { $version = "0.1.0" }
          Write-Host "Current version: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Find next available version
        id: next_version
        shell: pwsh
        run: |
          $packageId = 'omninet.sourcegenerators.core'
          # Poznámka: URL musí být bez mezer a z důvodu case sensitivity používáme malá písmena
          $url = "https://api.nuget.org/v3-flatcontainer/$packageId/index.json"
          try {
            $json = Invoke-RestMethod -Uri $url -UseBasicParsing
            $versions = $json.versions
          } catch {
            Write-Host "Package not found on NuGet.org, assuming first publish"
            $versions = @()
          }

          $current = '${{ steps.get_version.outputs.version }}'
          $parts = $current -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]

          $next = $patch
          do {
            $candidate = "$major.$minor.$next"
            $exists = $versions -contains $candidate
            if ($exists) { $next++ }
          } while ($exists)

          Write-Host "Next available version: $candidate"
          echo "version=$candidate" >> $env:GITHUB_OUTPUT

      - name: Update csproj version
        shell: pwsh
        run: |
          $csprojPath = "src/OmniNet.SourceGenerators.Core/OmniNet.SourceGenerators.Core.csproj"
          [xml]$proj = Get-Content $csprojPath
          $proj.Project.PropertyGroup.Version = '${{ steps.next_version.outputs.version }}'
          $proj.Save($csprojPath)

      - name: Restore dependencies
        run: dotnet restore "src/OmniNet.SourceGenerators.Core/OmniNet.SourceGenerators.Core.csproj"

      - name: Build project
        run: dotnet build "src/OmniNet.SourceGenerators.Core/OmniNet.SourceGenerators.Core.csproj" --configuration Release --no-restore

      - name: Create artifacts directory
        run: mkdir artifacts

      - name: Pack NuGet package
        run: dotnet pack "src/OmniNet.SourceGenerators.Core/OmniNet.SourceGenerators.Core.csproj" --configuration Release --no-build --output "artifacts"

      - name: Push to NuGet.org
        run: dotnet nuget push "artifacts/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate